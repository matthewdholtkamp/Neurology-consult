<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Neurology Consult Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#111827;      /* gray-900 */
      --panel:#1F2937;   /* gray-800 */
      --border:#374151;  /* gray-700 */
      --ink:#E5E7EB;     /* zinc-200 */
      --brand:#3B82F6;   /* blue-500 */
      --brand-2:#2563EB; /* blue-600 */
      --ink-weak:#9CA3AF;/* gray-400 */
      --panel-deeper:#0B1220;
    }
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--ink);}
    h1,h2,h3,h4,summary,button{font-family:'Roboto Condensed',sans-serif;letter-spacing:.5px}
    .hidden{display:none}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.25)}
    .btn{font-weight:600;padding:.75rem 1.25rem;border-radius:.5rem;box-shadow:0 1px 2px rgba(0,0,0,.25);transition:.15s transform;outline:0}
    .btn:hover{transform:translateY(-2px)}
    .btn-primary{background:var(--brand-2);color:#fff}
    .btn-primary:hover{background:var(--brand)}
    .btn-secondary{background:transparent;color:#93C5FD;border:1px solid var(--brand)}
    .btn-secondary:hover{background:var(--brand);color:#fff}
    .btn-back{background:#374151;color:#fff}
    .btn-back:hover{background:#4B5563}
    .error-box{display:none;background:rgba(239,68,68,.15);border:1px solid #DC2626;color:#FCA5A5;padding:1rem;border-radius:.5rem;margin-bottom:1rem}
    .spinner{border:4px solid rgba(255,255,255,.1);width:36px;height:36px;border-radius:50%;border-left-color:var(--brand);animation:spin 1s ease infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    details>summary{cursor:pointer}

    /* Inputs */
    .input{
      width:100%;padding:.6rem .75rem;border:1px solid var(--border);border-radius:.5rem;
      background:var(--panel-deeper); color:#F9FAFB;
    }
    .input:focus{outline:none;box-shadow:0 0 0 2px var(--brand)}
    textarea.input::placeholder, input.input::placeholder{color:var(--ink-weak)}

    /* Option cards */
    .card-option{border:2px solid var(--border);border-radius:1rem;padding:1rem;cursor:pointer;transition:.12s;user-select:none;background:var(--panel)}
    .card-option:hover{border-color:#60A5FA}
    .card-option.selected{border-color:#60A5FA;background:#0B1220}

    /* Consult visuals */
    #consult-output h3{font-size:1.125rem;font-weight:700;color:#93C5FD;margin:.75rem 0 .5rem}
    #consult-output strong{color:#F3F4F6}
    .rec-checkbox{width:26px;height:26px;transform:translateY(3px)}
    .rec-row{padding:14px;border-radius:.75rem;border:1px solid var(--border);margin-bottom:.5rem;background:#0f172a}
    .rec-row:hover{background:#0c1426}

    .hloc{padding:.75rem 1rem;border-radius:.75rem;border:1px solid var(--border);margin:.75rem 0}
    .hloc.alert{background:rgba(239,68,68,.18);border-color:#DC2626}
    .hloc.ok{background:rgba(16,185,129,.12);border-color:#10B981}

    .safeharbor{background:rgba(239,68,68,.12);border-color:#DC2626}
    .safeharbor .hd{color:#FCA5A5}
    .safeharbor li{color:#FCA5A5}
  </style>
</head>
<body>
  <div class="max-w-3xl mx-auto p-4 sm:p-8">

    <header class="text-center mb-6">
      <h1 class="text-3xl font-bold text-blue-500">AI NEUROLOGY CONSULT</h1>
      <p class="text-lg text-gray-300">Board-Certified AI Support for Providers</p>
    </header>

    <!-- Loading -->
    <div id="loading-spinner" class="hidden flex justify-center items-center p-6">
      <div class="spinner"></div>
      <p id="loading-text" class="ml-4 text-lg font-semibold text-gray-300">Working…</p>
    </div>

<!-- ================= 1) Intake Section ================= -->
<section id="section-symptoms" class="panel p-6">
  <!-- Safe Harbor (added to Intake) -->
  <details class="panel mb-6 safeharbor">
    <summary class="font-semibold p-3 cursor-pointer text-lg hd">De-identified Data Only (HIPAA Safe Harbor)</summary>
    <div class="p-4 border-t" style="border-color:#7F1D1D">
      <p class="font-bold text-red-200 mb-2">Do NOT include any of the following 18 identifiers:</p>
      <ol class="list-decimal list-inside space-y-1">
        <li>Names</li>
        <li>All geographic subdivisions smaller than a state (street, city, county, ZIP)</li>
        <li>All elements of dates (except year) related to an individual; all ages &gt; 89</li>
        <li>Telephone numbers</li>
        <li>Fax numbers</li>
        <li>Email addresses</li>
        <li>Social Security numbers</li>
        <li>Medical record numbers</li>
        <li>Health plan beneficiary numbers</li>
        <li>Account numbers</li>
        <li>Certificate/license numbers</li>
        <li>Vehicle identifiers and serial numbers, including license plates</li>
        <li>Device identifiers and serial numbers</li>
        <li>Web URLs</li>
        <li>IP addresses</li>
        <li>Biometric identifiers (e.g., fingerprints, voiceprints)</li>
        <li>Full-face photographs and comparable images</li>
        <li>Any other unique identifying number, characteristic, or code</li>
      </ol>
      <p class="mt-3 text-red-200"><strong>Actual knowledge rule:</strong> Even if the above are removed, do not include any detail that you know could identify the individual.</p>
    </div>
  </details>

  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold">1) De-identified Intake</h2>
    <button type="button" id="start-over-1" class="btn btn-back">Start Over</button>
  </div>

  <div id="error-message-symptoms" class="error-box"></div>

  <form id="symptom-form" novalidate>
    <label for="initial-symptoms" class="block text-sm font-medium text-gray-300 mb-1">Chief Complaint &amp; HPI:</label>
    <textarea id="initial-symptoms" rows="5" class="input" placeholder="e.g., Adult with sudden severe headache… CT head negative."></textarea>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div>
        <label for="pmh" class="block text-sm font-medium text-gray-300 mb-1">PMH:</label>
        <textarea id="pmh" rows="2" class="input" placeholder="HTN, HLD, Migraine…"></textarea>
      </div>
      <div>
        <label for="psh" class="block text-sm font-medium text-gray-300 mb-1">PSH:</label>
        <textarea id="psh" rows="2" class="input" placeholder="Appendectomy…"></textarea>
      </div>
      <div>
        <label for="allergies" class="block text-sm font-medium text-gray-300 mb-1">Allergies:</label>
        <textarea id="allergies" rows="2" class="input" placeholder="Penicillin (rash)…"></textarea>
      </div>
      <div>
        <label for="medications" class="block text-sm font-medium text-gray-300 mb-1">Medications:</label>
        <textarea id="medications" rows="2" class="input" placeholder="Lisinopril, Atorvastatin…"></textarea>
      </div>
    </div>

    <div class="mt-4">
      <label for="ros" class="block text-sm font-medium text-gray-300 mb-1">Review of Systems (pertinent):</label>
      <textarea id="ros" rows="3" class="input" placeholder="Neuro: …; CV: …; Resp: …; ID: …"></textarea>
    </div>

    <!-- Consult Source -->
    <div class="mt-6">
      <p class="block text-sm font-medium text-gray-300 mb-2">Consult Source (who is consulting Neurology):</p>
      <div id="consult-source-cards" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <button type="button" class="card-option" data-value="Outpatient" aria-pressed="false" tabindex="0">
          <h4 class="text-lg font-semibold text-white">Outpatient</h4>
          <p class="text-gray-300 text-sm">Clinic / PCM</p>
        </button>
        <button type="button" class="card-option" data-value="Inpatient" aria-pressed="false" tabindex="0">
          <h4 class="text-lg font-semibold text-white">Inpatient</h4>
          <p class="text-gray-300 text-sm">Ward / ICU</p>
        </button>
        <button type="button" class="card-option" data-value="ER" aria-pressed="false" tabindex="0">
          <h4 class="text-lg font-semibold text-white">ER</h4>
          <p class="text-gray-300 text-sm">Emergency Department</p>
        </button>
      </div>
      <input type="hidden" id="consult-source" value="">
    </div>

    <button type="button" id="example-complaint-btn" class="mt-4 text-sm text-blue-300 hover:underline">
      Use example: “30s with unilateral throbbing headache with aura…”
    </button>

    <div class="flex flex-wrap gap-3 mt-4">
      <button type="submit" class="btn btn-primary">Get Intake Questions</button>
      <button type="button" id="start-over-1b" class="btn btn-back">Start Over</button>
    </div>
  </form>
</section>

<!-- ================= 2) Questions ================= -->
<section id="section-intake-questions" class="panel p-6 mt-6 hidden">
  <!-- Safe Harbor -->
  <details class="panel mb-6 safeharbor">
    <summary class="font-semibold p-3 cursor-pointer text-lg hd">De-identified Data Only (HIPAA Safe Harbor)</summary>
    <div class="p-4 border-t" style="border-color:#7F1D1D">
      <p class="font-bold text-red-200 mb-2">Do NOT include any of the following 18 identifiers:</p>
      <ol class="list-decimal list-inside space-y-1">
        <li>Names</li>
        <li>All geographic subdivisions smaller than a state (street, city, county, ZIP)</li>
        <li>All elements of dates (except year) related to an individual; all ages &gt; 89</li>
        <li>Telephone numbers</li>
        <li>Fax numbers</li>
        <li>Email addresses</li>
        <li>Social Security numbers</li>
        <li>Medical record numbers</li>
        <li>Health plan beneficiary numbers</li>
        <li>Account numbers</li>
        <li>Certificate/license numbers</li>
        <li>Vehicle identifiers and serial numbers, including license plates</li>
        <li>Device identifiers and serial numbers</li>
        <li>Web URLs</li>
        <li>IP addresses</li>
        <li>Biometric identifiers (e.g., fingerprints, voiceprints)</li>
        <li>Full-face photographs and comparable images</li>
        <li>Any other unique identifying number, characteristic, or code</li>
      </ol>
      <p class="mt-3 text-red-200"><strong>Actual knowledge rule:</strong> Even if the above are removed, do not include any detail that you know could identify the individual.</p>
    </div>
  </details>

  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold">2) AI-Guided Intake (Questions Only)</h2>
    <div class="flex gap-2">
      <button type="button" id="back-to-hpi-btn" class="btn btn-back">&larr; Back</button>
      <button type="button" id="start-over-2" class="btn btn-back">Start Over</button>
    </div>
  </div>

  <p class="text-gray-300 mb-4">Answer the questions. No recommendations on this step.</p>
  <div id="error-message-intake" class="error-box"></div>

  <div class="mb-3">
    <label class="block text-sm font-medium text-gray-300 mb-1">Original Intake (context):</label>
    <div id="original-context-display" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-md text-gray-200 text-sm space-y-1"></div>
  </div>

  <form id="intake-form">
    <label id="opqrst-question-label" for="opqrst-answer" class="block text-gray-200 mb-1">OPQRST…</label>
    <textarea id="opqrst-answer" rows="2" class="input mb-3" placeholder="Answer…"></textarea>

    <label id="exam-question-label" for="exam-answer" class="block text-gray-200 mb-1">Neurologic exam &amp; vital signs…</label>
    <textarea id="exam-answer" rows="2" class="input mb-3" placeholder="Answer…"></textarea>

    <label id="imaging-question-label" for="imaging-answer" class="block text-gray-200 mb-1">Imaging findings (if any)…</label>
    <textarea id="imaging-answer" rows="2" class="input mb-3" placeholder="Answer…"></textarea>

    <label id="labs-question-label" for="labs-answer" class="block text-gray-200 mb-1">Pertinent labs (if any)…</label>
    <textarea id="labs-answer" rows="2" class="input" placeholder="Answer…"></textarea>

    <div class="flex flex-wrap gap-3 mt-4">
      <button type="submit" class="btn btn-primary">Get Final Consult</button>
      <button type="button" id="back-to-hpi-btn-2" class="btn btn-back">&larr; Back</button>
      <button type="button" id="start-over-2b" class="btn btn-back">Start Over</button>
    </div>
  </form>
</section>

<!-- ================= 3) Consult ================= -->
<section id="section-consult" class="panel p-6 mt-6 hidden">
  <!-- Safe Harbor -->
  <details class="panel mb-6 safeharbor">
    <summary class="font-semibold p-3 cursor-pointer text-lg hd">De-identified Data Only (HIPAA Safe Harbor)</summary>
    <div class="p-4 border-t" style="border-color:#7F1D1D">
      <p class="font-bold text-red-200 mb-2">Do NOT include any of the following 18 identifiers:</p>
      <ol class="list-decimal list-inside space-y-1">
        <li>Names</li>
        <li>All geographic subdivisions smaller than a state (street, city, county, ZIP)</li>
        <li>All elements of dates (except year) related to an individual; all ages &gt; 89</li>
        <li>Telephone numbers</li>
        <li>Fax numbers</li>
        <li>Email addresses</li>
        <li>Social Security numbers</li>
        <li>Medical record numbers</li>
        <li>Health plan beneficiary numbers</li>
        <li>Account numbers</li>
        <li>Certificate/license numbers</li>
        <li>Vehicle identifiers and serial numbers, including license plates</li>
        <li>Device identifiers and serial numbers</li>
        <li>Web URLs</li>
        <li>IP addresses</li>
        <li>Biometric identifiers (e.g., fingerprints, voiceprints)</li>
        <li>Full-face photographs and comparable images</li>
        <li>Any other unique identifying number, characteristic, or code</li>
      </ol>
      <p class="mt-3 text-red-200"><strong>Actual knowledge rule:</strong> Even if the above are removed, do not include any detail that you know could identify the individual.</p>
    </div>
  </details>

  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold">3) AI Neurology Consult</h2>
    <div class="flex gap-2">
      <button type="button" id="back-to-intake-btn" class="btn btn-back">&larr; Back</button>
      <button type="button" id="start-over-3" class="btn btn-back">Start Over</button>
    </div>
  </div>

  <div id="consult-output" class="mb-4 min-h-[200px]"><!-- injected --></div>

  <div class="flex flex-wrap gap-3">
    <button type="button" id="build-note-btn" class="btn btn-primary">Build Final Consult</button>
    <button type="button" id="copy-consult-btn" class="btn btn-secondary">Copy Consult to Clipboard</button>
  </div>
  <p id="copy-success" class="text-sm text-green-400 text-center mt-2 hidden">Copied!</p>
</section>

  </div>

  <script>
    /* ================= Config & Schemas ================= */
    const apiKey = ""; // <— set your key securely; do not hardcode in production
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    const SYSTEM_PROMPT_QUESTIONS = `
Return JSON only with keys {"opqrst","exam","imaging","labs"}.
Write four short QUESTIONS (no advice):
- opqrst: Onset, Palliation/Provocation, Quality, Radiation, Severity(1–10), Timing
- exam: Pertinent neuro exam and current vital signs
- imaging: Whether any imaging (CT/MRI) was done and findings
- labs: Whether labs (CBC/CMP/ESR/CRP/coags, etc.) were obtained and results
No extra text.`;

    function recItemSchema(){
      return {
        type:"OBJECT",
        properties:{
          id:{type:"STRING"},
          text:{type:"STRING"},
          selected:{type:"BOOLEAN"},
          alternatives:{type:"ARRAY",items:{type:"STRING"}},
          strength:{type:"STRING"}
        },
        required:["id","text","selected"]
      };
    }

    const SYSTEM_PROMPT_CONSULT = `
You are NeuroConsult AI, a board-certified neurologist. Use only current guidelines and high-quality evidence.
STRICT: Return JSON only per schema.

Requirements:
- ASSESSMENT: 2–4 sentences summarizing clinical picture.
- Immediately after ASSESSMENT include HIGHER LEVEL OF CARE (flag true/false). Destination must consider consult_source (Outpatient→ER; ER→Admit/Transfer; Inpatient→ICU/Transfer) if indicated.
- DDX:
  • most_likely {dx, probability_pct, confidence, rationale_for, rationale_against}
  • must_not_miss[1–4] same + consequence_of_miss
  • other[2–8] {dx, probability_pct, rationale_for, rationale_against}
  • Probabilities sum ~100% (±10%).
- PLAN (selectable items; alternatives; strength):
  • immediate_actions[]
  • workup as PLAN subsections: labs[], imaging[], diagnostics[]  (each test as its own item; e.g., CBC, CMP, ESR/CRP, CT head, CTA head/neck, MRI brain, MRA, MRV, Spine MRI, EEG, LP, etc.), each tailored to consult_source and presentation.
    - For labs/imaging/diagnostics include top_recommendation strings naming what you most recommend first (no location statements).
  • management_initial[] — include ≥5 treatment options with dosing where applicable (no statements about where performed).
  • consults[]
  • higher_level_of_care {er:boolean, admit:boolean, rationale:string, destination:string}
  • follow_up[]
  • military_profile {recommend_profile:boolean, length_days:number, commander_instructions:string, service_member_instructions:string}
    - No “category”.
- REFERENCES: 5–12 APA with url.
- NOTE_TEXT: Build complete EMR-ready note with sections:
  HPI, ROS, PMH, Meds, Allergies, Consult Source; ASSESSMENT; HIGHER LEVEL OF CARE; DIFFERENTIAL (with % and confidence); PLAN (subsections: immediate actions; labs; imaging; diagnostics; initial management; consults; follow-up; military profile); REFERENCES with superscripts.
Do not include any separate “Assessment & Plan” duplicate block.`;

    const QUESTIONS_SCHEMA = {
      type:"OBJECT",
      properties:{
        opqrst:{type:"STRING"},
        exam:{type:"STRING"},
        imaging:{type:"STRING"},
        labs:{type:"STRING"}
      },
      required:["opqrst","exam","imaging","labs"]
    };

    const CONSULT_SCHEMA = {
      type:"OBJECT",
      properties:{
        impression:{type:"STRING"},
        higher_level_of_care:{type:"OBJECT",properties:{
          er:{type:"BOOLEAN"},
          admit:{type:"BOOLEAN"},
          rationale:{type:"STRING"},
          destination:{type:"STRING"}
        },required:["er","admit","rationale","destination"]},
        ddx:{type:"OBJECT",properties:{
          most_likely:{type:"OBJECT",properties:{
            dx:{type:"STRING"},
            probability_pct:{type:"NUMBER"},
            confidence:{type:"STRING"},
            rationale_for:{type:"STRING"},
            rationale_against:{type:"STRING"}
          },required:["dx","probability_pct","confidence","rationale_for","rationale_against"]},
          must_not_miss:{type:"ARRAY",items:{type:"OBJECT",properties:{
            dx:{type:"STRING"},
            probability_pct:{type:"NUMBER"},
            confidence:{type:"STRING"},
            rationale_for:{type:"STRING"},
            rationale_against:{type:"STRING"},
            consequence_of_miss:{type:"STRING"}
          },required:["dx","probability_pct","confidence","rationale_for","rationale_against","consequence_of_miss"]}},
          other:{type:"ARRAY",items:{type:"OBJECT",properties:{
            dx:{type:"STRING"},
            probability_pct:{type:"NUMBER"},
            rationale_for:{type:"STRING"},
            rationale_against:{type:"STRING"}
          },required:["dx","probability_pct","rationale_for","rationale_against"]}}
        },required:["most_likely","must_not_miss","other"]},
        plan:{type:"OBJECT",properties:{
          immediate_actions:{type:"ARRAY",items:recItemSchema()},
          workup:{type:"OBJECT",properties:{
            labs:{type:"ARRAY",items:recItemSchema()},
            labs_top_recommendation:{type:"STRING"},
            imaging:{type:"ARRAY",items:recItemSchema()},
            imaging_top_recommendation:{type:"STRING"},
            diagnostics:{type:"ARRAY",items:recItemSchema()},
            diagnostics_top_recommendation:{type:"STRING"}
          },required:["labs","labs_top_recommendation","imaging","imaging_top_recommendation","diagnostics","diagnostics_top_recommendation"]},
          management_initial:{type:"ARRAY",items:recItemSchema()},
          consults:{type:"ARRAY",items:recItemSchema()},
          higher_level_of_care:{type:"OBJECT",properties:{
            er:{type:"BOOLEAN"},admit:{type:"BOOLEAN"},
            rationale:{type:"STRING"},destination:{type:"STRING"}
          },required:["er","admit","rationale","destination"]},
          follow_up:{type:"ARRAY",items:recItemSchema()},
          military_profile:{type:"OBJECT",properties:{
            recommend_profile:{type:"BOOLEAN"},
            length_days:{type:"NUMBER"},
            commander_instructions:{type:"STRING"},
            service_member_instructions:{type:"STRING"}
          },required:["recommend_profile","length_days","commander_instructions","service_member_instructions"]}
        },required:["immediate_actions","workup","management_initial","consults","higher_level_of_care","follow_up","military_profile"]},
        references:{type:"ARRAY",items:{type:"OBJECT",properties:{
          citation_apa:{type:"STRING"},url:{type:"STRING"}
        },required:["citation_apa","url"]}},
        note_text:{type:"STRING"}
      },
      required:["impression","higher_level_of_care","ddx","plan","references","note_text"]
    };

    /* ================= DOM refs ================= */
    const sectionSymptoms=document.getElementById('section-symptoms');
    const sectionIntake=document.getElementById('section-intake-questions');
    const sectionConsult=document.getElementById('section-consult');
    const loadingSpinner=document.getElementById('loading-spinner');
    const loadingText=document.getElementById('loading-text');

    const formSymptoms=document.getElementById('symptom-form');
    const errorSymptoms=document.getElementById('error-message-symptoms');
    const exampleBtn=document.getElementById('example-complaint-btn');

    const initialSymptoms=document.getElementById('initial-symptoms');
    const pmh=document.getElementById('pmh');
    const psh=document.getElementById('psh');
    const allergies=document.getElementById('allergies');
    const medications=document.getElementById('medications');
    const ros=document.getElementById('ros');

    const consultSourceCards=document.getElementById('consult-source-cards');
    const consultSourceInput=document.getElementById('consult-source');

    const originalContextDisplay=document.getElementById('original-context-display');
    const intakeForm=document.getElementById('intake-form');
    const errorIntake=document.getElementById('error-message-intake');

    const opqrstQuestionLabel=document.getElementById('opqrst-question-label');
    const examQuestionLabel=document.getElementById('exam-question-label');
    const imagingQuestionLabel=document.getElementById('imaging-question-label');
    const labsQuestionLabel=document.getElementById('labs-question-label');

    const opqrstAnswer=document.getElementById('opqrst-answer');
    const examAnswer=document.getElementById('exam-answer');
    const imagingAnswer=document.getElementById('imaging-answer');
    const labsAnswer=document.getElementById('labs-answer');

    const backToHpiBtn=document.getElementById('back-to-hpi-btn');
    const backToHpiBtn2=document.getElementById('back-to-hpi-btn-2');
    const startOver1=document.getElementById('start-over-1');
    const startOver1b=document.getElementById('start-over-1b');
    const startOver2=document.getElementById('start-over-2');
    const startOver2b=document.getElementById('start-over-2b');
    const startOver3=document.getElementById('start-over-3');
    const backToIntakeBtn=document.getElementById('back-to-intake-btn');

    const consultOutput=document.getElementById('consult-output');
    const copyBtn=document.getElementById('copy-consult-btn');
    const buildBtn=document.getElementById('build-note-btn');
    const copySuccess=document.getElementById('copy-success');

    let currentPatient={};
    let modelConsult=null;

    /* ================= Helpers ================= */
    function setLoading(on,msg="Working…"){ if(on){loadingText.textContent=msg;loadingSpinner.classList.remove('hidden')}else{loadingSpinner.classList.add('hidden')} }
    async function fetchWithBackoff(url,opt,retries=3,delay=800){
      for(let i=0;i<retries;i++){
        try{
          const r=await fetch(url,opt); if(r.ok) return r;
          if(r.status>=400&&r.status<500) throw new Error(`Client ${r.status}`);
          await new Promise(res=>setTimeout(res,delay)); delay*=2;
        }catch(e){
          if(i===retries-1) throw e;
          await new Promise(res=>setTimeout(res,delay)); delay*=2;
        }
      }
    }
    async function getAiResponse(user,sys,schema=null){
      const payload={contents:[{parts:[{text:user}]}],systemInstruction:{parts:[{text:sys}]}}
      if(schema){payload.generationConfig={responseMimeType:"application/json",responseSchema:schema}}
      const r=await fetchWithBackoff(apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      if(!r.ok) throw new Error(`API ${r.status}`);
      const j=await r.json(); const t=j?.candidates?.[0]?.content?.parts?.[0]?.text;
      if(!t) throw new Error("No content"); return t;
    }
    function escapeHtml(s){return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}

    /* ================= Consult Source Cards ================= */
    function clearCards(){
      consultSourceCards.querySelectorAll(".card-option").forEach(c=>{
        c.classList.remove("selected");
        c.setAttribute("aria-pressed","false");
      });
    }
    function selectCard(btn){
      clearCards();
      btn.classList.add("selected");
      btn.setAttribute("aria-pressed","true");
      consultSourceInput.value = btn.dataset.value || "";
    }
    consultSourceCards.addEventListener('click',e=>{
      const card=e.target.closest('.card-option'); if(!card) return; selectCard(card);
    });
    // Keyboard a11y
    consultSourceCards.querySelectorAll(".card-option").forEach(btn=>{
      btn.addEventListener("keydown",e=>{
        if(e.key==="Enter"||e.key===" "){ e.preventDefault(); selectCard(btn); }
      });
    });

    /* Example button */
    exampleBtn.addEventListener('click', ()=>{
      initialSymptoms.value='30s with 2 weeks of unilateral throbbing headache preceded by visual scintillating scotoma; similar prior episodes; no focal deficits. Question: confirm diagnosis.';
      pmh.value='Migraine with aura; seasonal allergies';
      psh.value='None';
      allergies.value='Sulfa (anaphylaxis)';
      medications.value='Loratadine PRN';
      ros.value='Neuro: +photophobia; –weakness, –vision loss. ID: –fever. CV: –chest pain.';
      const outCard=consultSourceCards.querySelector('[data-value="Outpatient"]');
      if(outCard) selectCard(outCard);
      errorSymptoms.style.display="none";
      errorSymptoms.textContent="";
    });

    /* ================= Step 1 → Questions ================= */
    formSymptoms.addEventListener('submit', async e=>{
      e.preventDefault();
      if(!initialSymptoms.value.trim()){
        errorSymptoms.textContent="Enter a chief complaint/HPI.";
        errorSymptoms.style.display="block"; return;
      }
      if(!consultSourceInput.value){
        errorSymptoms.textContent="Select a Consult Source.";
        errorSymptoms.style.display="block"; return;
      }
      errorSymptoms.style.display="none";

      currentPatient={
        hpi:initialSymptoms.value.trim(),
        pmh:pmh.value.trim(), psh:psh.value.trim(),
        allergies:allergies.value.trim(), medications:medications.value.trim(),
        ros:ros.value.trim(), consult_source:consultSourceInput.value
      };

      sectionSymptoms.classList.add('hidden'); setLoading(true,"Generating Intake Questions…");
      try{
        const u = `Chief complaint/HPI: ${currentPatient.hpi}
PMH: ${currentPatient.pmh||'Not provided'}
PSH: ${currentPatient.psh||'Not provided'}
Allergies: ${currentPatient.allergies||'Not provided'}
Medications: ${currentPatient.medications||'Not provided'}
ROS: ${currentPatient.ros||'Not provided'}
Consult source: ${currentPatient.consult_source}`;
        const qJson = await getAiResponse(u,SYSTEM_PROMPT_QUESTIONS,QUESTIONS_SCHEMA);
        const q = JSON.parse(qJson);

        originalContextDisplay.innerHTML = `
          <p><strong>Consult source:</strong> ${escapeHtml(currentPatient.consult_source)}</p>
          <p><strong>HPI:</strong> ${escapeHtml(currentPatient.hpi)}</p>
          <p><strong>PMH:</strong> ${escapeHtml(currentPatient.pmh||'N/A')}</p>
          <p><strong>PSH:</strong> ${escapeHtml(currentPatient.psh||'N/A')}</p>
          <p><strong>Allergies:</strong> ${escapeHtml(currentPatient.allergies||'N/A')}</p>
          <p><strong>Medications:</strong> ${escapeHtml(currentPatient.medications||'N/A')}</p>
          <p><strong>ROS:</strong> ${escapeHtml(currentPatient.ros||'N/A')}</p>
        `;
        opqrstQuestionLabel.textContent=q.opqrst;
        examQuestionLabel.textContent=q.exam;
        imagingQuestionLabel.textContent=q.imaging;
        labsQuestionLabel.textContent=q.labs;
        opqrstAnswer.value=examAnswer.value=imagingAnswer.value=labsAnswer.value="";

        setLoading(false); sectionIntake.classList.remove('hidden');
        window.scrollTo({top:0,behavior:'smooth'});
      }catch(err){
        setLoading(false); sectionSymptoms.classList.remove('hidden');
        errorSymptoms.textContent="Failed to generate questions (check API key/network).";
        errorSymptoms.style.display="block"; console.error(err);
      }
    });

    /* ================= Questions → Consult ================= */
    intakeForm.addEventListener('submit', async e=>{
      e.preventDefault(); errorIntake.style.display="none";
      sectionIntake.classList.add('hidden'); setLoading(true,"Consulting Neurologist…");

      const prompt = `
Intake summary for Neurology:
Consult source: ${currentPatient.consult_source}
HPI: ${currentPatient.hpi}
PMH: ${currentPatient.pmh || 'Not provided'}
PSH: ${currentPatient.psh || 'Not provided'}
Allergies: ${currentPatient.allergies || 'Not provided'}
Medications: ${currentPatient.medications || 'Not provided'}
ROS: ${currentPatient.ros || 'Not provided'}

Follow-up (answers to questions):
OPQRST: ${opqrstAnswer.value.trim() || 'Not provided'}
Neuro exam & VS: ${examAnswer.value.trim() || 'Not provided'}
Imaging findings: ${imagingAnswer.value.trim() || 'Not provided'}
Labs: ${labsAnswer.value.trim() || 'Not provided'}

Return JSON only per schema.`;
      try{
        const resp = await getAiResponse(prompt,SYSTEM_PROMPT_CONSULT,CONSULT_SCHEMA);
        modelConsult = JSON.parse(resp);
        renderConsultInteractive(modelConsult);
        setLoading(false); sectionConsult.classList.remove('hidden');
        window.scrollTo({top:0,behavior:'smooth'});
      }catch(err){
        console.error(err); setLoading(false); sectionIntake.classList.remove('hidden');
        errorIntake.textContent="Failed to get final consult (check API key/network).";
        errorIntake.style.display="block";
      }
    });

    /* ================= Render Consult ================= */
    function listItems(items, groupKey){
      if(!Array.isArray(items)) return "";
      return items.map(it=>`
        <label class="rec-row flex items-start gap-3">
          <input type="checkbox" class="rec-checkbox" data-group="${groupKey}" data-id="${escapeHtml(it.id)}" ${it.selected?'checked':''}>
          <span class="leading-snug text-gray-100">
            ${escapeHtml(it.text)}${it.strength?` <em class="text-gray-300">(strength: ${escapeHtml(it.strength)})</em>`:''}
            ${it.alternatives?.length?`<br><small class="text-gray-400">Alternatives: ${escapeHtml(it.alternatives.join(' | '))}</small>`:''}
          </span>
        </label>
      `).join('');
    }

    function renderConsultInteractive(c){
      const el=consultOutput; if(!el) return;
      const hlocTrue=c.higher_level_of_care?.er || c.higher_level_of_care?.admit;
      const hlocCls=`hloc ${hlocTrue?'alert':'ok'}`;
      const hlocTitle=hlocTrue?'Higher Level of Care Recommended':'Higher Level of Care Not Indicated';
      const dest=c.higher_level_of_care?.destination?` — Destination: ${escapeHtml(c.higher_level_of_care.destination)}`:'';

      const ddxOther=(c.ddx.other||[]).slice(0,5);
      const otherQuick = ddxOther.length ? `
        <div class="mt-2">
          <strong>Other possible diagnoses to consider:</strong>
          ${ddxOther.map((o,i)=>`
            <label class="rec-row flex items-start gap-3">
              <input type="checkbox" class="rec-checkbox" data-group="ddx.other.consider" data-id="other_${i}" checked>
              <span class="text-gray-100">${escapeHtml(o.dx)} — ${o.probability_pct}%</span>
            </label>
          `).join('')}
        </div>` : '';

      el.innerHTML = `
        <h3>ASSESSMENT</h3>
        <p class="text-gray-100">${escapeHtml(c.impression)}</p>

        <div class="${hlocCls}">
          <strong>${hlocTitle}</strong>${dest}
          <p class="mt-1 text-gray-100"><em>Rationale:</em> ${escapeHtml(c.higher_level_of_care?.rationale || '')}</p>
        </div>

        <h3>DIFFERENTIAL DIAGNOSIS</h3>
        <p class="text-gray-100"><strong>Most likely:</strong> ${escapeHtml(c.ddx.most_likely.dx)} — ${c.ddx.most_likely.probability_pct}% (confidence: ${escapeHtml(c.ddx.most_likely.confidence)})</p>
        <p class="text-gray-100"><em>Why:</em> ${escapeHtml(c.ddx.most_likely.rationale_for)}</p>
        <p class="text-gray-100"><em>Why not:</em> ${escapeHtml(c.ddx.most_likely.rationale_against)}</p>

        <p class="mt-2 text-gray-100"><strong>Must not miss:</strong></p>
        ${c.ddx.must_not_miss.map(m=>`
          <div class="ml-2">
            <p class="text-gray-100">${escapeHtml(m.dx)} — ${m.probability_pct}% (confidence: ${escapeHtml(m.confidence)})</p>
            <p class="text-gray-100"><em>Why:</em> ${escapeHtml(m.rationale_for)}</p>
            <p class="text-gray-100"><em>Why not:</em> ${escapeHtml(m.rationale_against)}</p>
            <p class="text-gray-100"><em>Consequence if missed:</em> ${escapeHtml(m.consequence_of_miss)}</p>
          </div>
        `).join('')}

        ${otherQuick}

        <h3>PLAN (select items to include)</h3>

        <strong>Immediate actions</strong>
        <div>${listItems(c.plan.immediate_actions,'immediate_actions')}</div>

        <strong class="block mt-2">Plan – Labs</strong>
        <p class="text-sm italic mb-1 text-gray-300">Top recommendation: ${escapeHtml(c.plan.workup.labs_top_recommendation || '')}</p>
        <div>${listItems(c.plan.workup.labs,'workup.labs')}</div>

        <strong class="block mt-2">Plan – Imaging</strong>
        <p class="text-sm italic mb-1 text-gray-300">Top recommendation: ${escapeHtml(c.plan.workup.imaging_top_recommendation || '')}</p>
        <div>${listItems(c.plan.workup.imaging,'workup.imaging')}</div>

        <strong class="block mt-2">Plan – Diagnostics</strong>
        <p class="text-sm italic mb-1 text-gray-300">Top recommendation: ${escapeHtml(c.plan.workup.diagnostics_top_recommendation || '')}</p>
        <div>${listItems(c.plan.workup.diagnostics,'workup.diagnostics')}</div>

        <strong class="block mt-2">Initial management (≥5 options)</strong>
        <div>${listItems(c.plan.management_initial,'management_initial')}</div>

        <strong class="block mt-2">Consults</strong>
        <div>${listItems(c.plan.consults,'consults')}</div>

        <strong class="block mt-2">Follow-up</strong>
        <div>${listItems(c.plan.follow_up,'follow_up')}</div>

        <strong class="block mt-2">Military profile</strong>
        <div class="mb-2 p-3 border border-gray-700 rounded-lg">
          <label class="flex items-center gap-2 mb-2">
            <input type="checkbox" id="profile-recommend" ${c.plan.military_profile.recommend_profile ? 'checked':''}>
            <span class="text-gray-100">Recommend profile</span>
          </label>
          <div class="flex items-center gap-2 mb-2">
            <span class="text-gray-100">Length (days):</span>
            <button type="button" id="profile-len-dec" class="btn btn-secondary py-1 px-2" aria-label="Decrease profile length">−</button>
            <span id="profile-length" data-value="${Number(c.plan.military_profile.length_days)||7}" class="px-2 text-gray-100">${Number(c.plan.military_profile.length_days)||7}</span>
            <button type="button" id="profile-len-inc" class="btn btn-secondary py-1 px-2" aria-label="Increase profile length">+</button>
          </div>
          <div class="pl-4">
            <p class="mb-3 text-gray-100"><em>Commander instructions:</em><br>
              <span id="profile-commander" data-value="${escapeHtml(c.plan.military_profile.commander_instructions)}">${escapeHtml(c.plan.military_profile.commander_instructions)}</span>
            </p>
            <p class="mb-1 text-gray-100"><em>Service member instructions:</em><br>
              <span id="profile-sm" data-value="${escapeHtml(c.plan.military_profile.service_member_instructions)}">${escapeHtml(c.plan.military_profile.service_member_instructions)}</span>
            </p>
          </div>
        </div>

        <h3>References</h3>
        <ol class="list-decimal list-inside">
          ${c.references.map((r,i)=>`<li>[${i+1}] ${escapeHtml(r.citation_apa)} <a href="${r.url}" target="_blank">${r.url}</a></li>`).join('')}
        </ol>
      `;

      // Profile length controls
      document.getElementById('profile-len-inc').addEventListener('click', ()=>{
        const sp=document.getElementById('profile-length'); const v=Number(sp.dataset.value)||0; sp.dataset.value=String(v+1); sp.textContent=String(v+1);
      });
      document.getElementById('profile-len-dec').addEventListener('click', ()=>{
        const sp=document.getElementById('profile-length'); const v=Number(sp.dataset.value)||0; const nv=Math.max(0,v-1); sp.dataset.value=String(nv); sp.textContent=String(nv);
      });
    }

    /* ================= Build + Copy ================= */
    function itemsByIds(items, ids){ const map=new Map((items||[]).map(i=>[i.id,i])); return ids.map(id=>map.get(id)).filter(Boolean); }
    function getChecked(group){ return [...document.querySelectorAll(`.rec-checkbox[data-group="${group}"]`)].filter(cb=>cb.checked).map(cb=>cb.dataset.id); }

    function buildFinalConsultText(){
      const c=modelConsult; if(!c) return "";
      const sel={
        immediate: itemsByIds(c.plan.immediate_actions, getChecked('immediate_actions')),
        labs: itemsByIds(c.plan.workup.labs, getChecked('workup.labs')),
        imaging: itemsByIds(c.plan.workup.imaging, getChecked('workup.imaging')),
        diagnostics: itemsByIds(c.plan.workup.diagnostics, getChecked('workup.diagnostics')),
        mgmt: itemsByIds(c.plan.management_initial, getChecked('management_initial')),
        consults: itemsByIds(c.plan.consults, getChecked('consults')),
        follow: itemsByIds(c.plan.follow_up, getChecked('follow_up')),
      };

      const lines=[];
      lines.push("HPI:"); lines.push(currentPatient.hpi||""); lines.push("");
      lines.push("ROS:"); lines.push(currentPatient.ros||""); lines.push("");
      lines.push("PMH:"); lines.push(currentPatient.pmh||""); lines.push("");
      lines.push("Medications:"); lines.push(currentPatient.medications||""); lines.push("");
      lines.push("Allergies:"); lines.push(currentPatient.allergies||""); lines.push("");
      lines.push(`Consult Source: ${currentPatient.consult_source}`); lines.push("");

      lines.push("ASSESSMENT:"); lines.push(c.impression); lines.push("");

      lines.push("HIGHER LEVEL OF CARE:");
      const recHLOC = (c.plan.higher_level_of_care?.er || c.plan.higher_level_of_care?.admit);
      lines.push(`• Recommended: ${recHLOC ? "Yes" : "No"}`);
      if(recHLOC){ lines.push(`• Destination: ${c.plan.higher_level_of_care.destination || "—"}`); }
      lines.push(`• Rationale: ${c.plan.higher_level_of_care.rationale || ""}`); lines.push("");

      lines.push("DIFFERENTIAL DIAGNOSIS:");
      const ml=c.ddx.most_likely;
      lines.push(`• Most likely: ${ml.dx} — ${ml.probability_pct}% (confidence: ${ml.confidence})`);
      lines.push(`  Why: ${ml.rationale_for}`);
      lines.push(`  Why not: ${ml.rationale_against}`);
      lines.push("• Must not miss:");
      (c.ddx.must_not_miss||[]).forEach(m=>{
        lines.push(`  - ${m.dx} — ${m.probability_pct}% (confidence: ${m.confidence}); Consequence: ${m.consequence_of_miss}`);
        lines.push(`    Why: ${m.rationale_for}`);
        lines.push(`    Why not: ${m.rationale_against}`);
      });
      lines.push("• Other:");
      (c.ddx.other||[]).forEach(o=>{
        lines.push(`  - ${o.dx} — ${o.probability_pct}%`);
        lines.push(`    Why: ${o.rationale_for}`);
        lines.push(`    Why not: ${o.rationale_against}`);
      });
      lines.push("");

      lines.push("PLAN:");
      lines.push("• Immediate actions:"); sel.immediate.forEach(i=>lines.push(`  - ${i.text}${i.strength?` (strength: ${i.strength})`:""}`));
      lines.push(`• Labs (Top: ${c.plan.workup.labs_top_recommendation||""}):`); sel.labs.forEach(i=>lines.push(`  - ${i.text}${i.strength?` (strength: ${i.strength})`:""}`));
      lines.push(`• Imaging (Top: ${c.plan.workup.imaging_top_recommendation||""}):`); sel.imaging.forEach(i=>lines.push(`  - ${i.text}${i.strength?` (strength: ${i.strength})`:""}`));
      lines.push(`• Diagnostics (Top: ${c.plan.workup.diagnostics_top_recommendation||""}):`); sel.diagnostics.forEach(i=>lines.push(`  - ${i.text}${i.strength?` (strength: ${i.strength})`:""}`));
      lines.push("• Initial management:"); sel.mgmt.forEach(i=>lines.push(`  - ${i.text}${i.strength?` (strength: ${i.strength})`:""}`));
      lines.push("• Consults:"); sel.consults.forEach(i=>lines.push(`  - ${i.text}${i.strength?` (strength: ${i.strength})`:""}`));
      lines.push("• Follow-up:"); sel.follow.forEach(i=>lines.push(`  - ${i.text}${i.strength?` (strength: ${i.strength})`:""}`));
      lines.push("");

      lines.push("REFERENCES:");
      (c.references||[]).forEach((r,i)=>lines.push(`${i+1}. ${r.citation_apa} ${r.url}`));
      return lines.join("\n");
    }

    // Build & Copy
    buildBtn.addEventListener('click', ()=>{
      const note=buildFinalConsultText();
      consultOutput.innerText = note || "No note content.";
    });

    copyBtn.addEventListener('click', async ()=>{
      const text=consultOutput.innerText || consultOutput.textContent || "";
      if(!text) return;
      try{
        if(navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
        copySuccess.classList.remove('hidden'); setTimeout(()=>copySuccess.classList.add('hidden'),1500);
      }catch(e){ console.error("Clipboard error", e); }
    });

    // Navigation
    function resetAll(){
      initialSymptoms.value=pmh.value=psh.value=allergies.value=medications.value=ros.value="";
      consultSourceInput.value=""; clearCards();
      opqrstAnswer.value=examAnswer.value=imagingAnswer.value=labsAnswer.value="";
      modelConsult=null; currentPatient={};
      document.getElementById('error-message-symptoms').style.display="none";
      const emi=document.getElementById('error-message-intake'); if(emi) emi.style.display="none";
      sectionConsult.classList.add('hidden');
      sectionIntake.classList.add('hidden');
      sectionSymptoms.classList.remove('hidden');
      consultOutput.innerHTML="";
      window.scrollTo({top:0,behavior:'smooth'});
    }
    document.getElementById('start-over-1').addEventListener('click',resetAll);
    document.getElementById('start-over-1b').addEventListener('click',resetAll);
    document.getElementById('start-over-2').addEventListener('click',resetAll);
    document.getElementById('start-over-2b').addEventListener('click',resetAll);
    document.getElementById('start-over-3').addEventListener('click',resetAll);

    document.getElementById('back-to-hpi-btn').addEventListener('click',()=>{sectionIntake.classList.add('hidden');sectionSymptoms.classList.remove('hidden');window.scrollTo({top:0,behavior:'smooth'})});
    document.getElementById('back-to-hpi-btn-2').addEventListener('click',()=>{sectionIntake.classList.add('hidden');sectionSymptoms.classList.remove('hidden');window.scrollTo({top:0,behavior:'smooth'})});
    document.getElementById('back-to-intake-btn').addEventListener('click',()=>{sectionConsult.classList.add('hidden');sectionIntake.classList.remove('hidden');window.scrollTo({top:0,behavior:'smooth'})});
  </script>
</body>
</html>
